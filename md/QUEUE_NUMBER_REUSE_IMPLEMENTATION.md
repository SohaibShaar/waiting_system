# ๐ ุชุทุจูู ุฅุนุงุฏุฉ ุงุณุชุฎุฏุงู ุฃุฑูุงู ุงูุฃุฏูุงุฑ ุงูููุบุงุฉ

## ๐ ูุธุฑุฉ ุนุงูุฉ

ุชู ุชุทุจูู **ุงูุญู 1** ููุนุงูุฌุฉ ูุดููุฉ ุงููุฌูุงุช ูู ุฃุฑูุงู ุงูุฃุฏูุงุฑ ุงููุงุชุฌุฉ ุนู ุฅูุบุงุก ุงูุฃุฏูุงุฑ ูุฅุนุงุฏุฉ ุชูุนูููุง.

## ๐ฏ ุงููุฏู

- **ุงููุดููุฉ**: ุนูุฏ ุฅูุบุงุก ุฏูุฑ ูุฅุนุงุฏุฉ ุชูุนูููุ ูุงู ูุญุตู ุนูู ุฑูู ุฌุฏูุฏ ููุง ูุณุจุจ ูุฌูุงุช ูู ุงูุฃุฑูุงู
- **ุงูุญู**: ุฅุนุงุฏุฉ ุงุณุชุฎุฏุงู ุฃุฑูุงู ุงูุฃุฏูุงุฑ ุงูููุบุงุฉ ุจุฏูุงู ูู ุฅูุดุงุก ุฃุฑูุงู ุฌุฏูุฏุฉ

## โจ ุงูุชุบููุฑุงุช ุงููุทุจูุฉ

### 1๏ธโฃ ุฅุถุงูุฉ ูุธููุฉ `getNextAvailableQueueNumber()`

```typescript
/**
 * ุงูุญุตูู ุนูู ุฑูู ุฏูุฑ ูุชุงุญ (ุฅุนุงุฏุฉ ุงุณุชุฎุฏุงู ุฃุฑูุงู ุงูุฃุฏูุงุฑ ุงูููุบุงุฉ)
 * ูุจุญุซ ุนู ุฃูู ุฑูู ุฏูุฑ ููุบู ูู ููุณ ุงููููุ ูุฅุฐุง ูู ูุฌุฏ ูุนุทู ุฑูู ุฌุฏูุฏ
 */
async function getNextAvailableQueueNumber(): Promise<number>
```

**ุงููุธููุฉ:**
- ุชุจุญุซ ุนู ุฃูู ุฑูู ุฏูุฑ ููุบู ูู ููุณ ุงูููู
- ุฅุฐุง ูุฌุฏุช ุฑูู ููุบูุ ุชุนูุฏู ูุฅุนุงุฏุฉ ุงุณุชุฎุฏุงูู
- ุฅุฐุง ูู ุชุฌุฏุ ุชุนุทู ุฑูู ุฌุฏูุฏ (ุขุฎุฑ ุฑูู + 1)

**ุงููููุน:** `src/services/queue.service.ts` (ุงูุณุทูุฑ 45-82)

---

### 2๏ธโฃ ุชุญุฏูุซ ูุธููุฉ `reinstateQueue()`

**ุงูุชุบููุฑุงุช:**
- โ **ูุจู**: ูุงูุช ุชุญุตู ุนูู ุฑูู ุฏูุฑ ุฌุฏูุฏ (`lastNumber + 1`)
- โ **ุจุนุฏ**: ุชุนูุฏ ุงุณุชุฎุฏุงู ููุณ ุฑูู ุงูุฏูุฑ ุงูููุบู (`cancelledQueue.queueNumber`)

**ุงูููุฏ ุงูุฌุฏูุฏ:**
```typescript
// 2. ุฅุนุงุฏุฉ ุงุณุชุฎุฏุงู ููุณ ุฑูู ุงูุฏูุฑ ุงููุฏูู
const reusedQueueNumber = cancelledQueue.queueNumber;

// 4. ุฅูุดุงุก Queue ุฌุฏูุฏ ุจููุณ ุฑูู ุงูุฏูุฑ
const newQueue = await prisma.queue.create({
  data: {
    queueNumber: reusedQueueNumber, // โป๏ธ ุฅุนุงุฏุฉ ุงุณุชุฎุฏุงู ููุณ ุงูุฑูู
    // ... ุจููุฉ ุงูุจูุงูุงุช
  },
});

// 7. ูุง ุญุงุฌุฉ ูุชุญุฏูุซ LAST_QUEUE_NUMBER ูุฃููุง ูุนูุฏ ุงุณุชุฎุฏุงู ุฑูู ูุฏูู
```

**ุงููููุน:** `src/services/queue.service.ts` (ุงูุณุทูุฑ 198-324)

---

## ๐ ููู ูุนูู ุงููุธุงู ุงูุขูุ

### ุณููุงุฑูู 1: ุฅุนุงุฏุฉ ุชูุนูู ุฏูุฑ ููุบู

```
1. ุงูุฏูุฑ #5 ุชู ุฅูุบุงุคู โ
2. ุขุฎุฑ ุฑูู ุฏูุฑ ูุดุท: #10
3. ุฅุนุงุฏุฉ ุชูุนูู ุงูุฏูุฑ #5:
   - ูุชู ุญุฐู ุงูุฏูุฑ ุงููุฏูู (id: 5)
   - ูุชู ุฅูุดุงุก ุฏูุฑ ุฌุฏูุฏ (id: 15, queueNumber: 5) โ
   - ุงููุชูุฌุฉ: ุฑูู ุงูุฏูุฑ ูุจูู #5 (ูุง ูุฌูุงุช!)
```

### ุณููุงุฑูู 2: ุฅูุบุงุก ุนุฏุฉ ุฃุฏูุงุฑ

```
ุงูุฃุฏูุงุฑ ุงููุดุทุฉ: #1, #2, #3, #4, #5, #6, #7, #8, #9, #10

ุฅูุบุงุก ุงูุฃุฏูุงุฑ: #3, #5, #7 โ

ุงูุฃุฏูุงุฑ ุงููุดุทุฉ: #1, #2, #4, #6, #8, #9, #10
ุงูุฃุฏูุงุฑ ุงูููุบุงุฉ: #3, #5, #7

ุนูุฏ ุฅูุดุงุก ุฏูุฑ ุฌุฏูุฏ:
- getNextAvailableQueueNumber() ุชุจุญุซ ุนู ุฃูู ุฑูู ููุบู
- ุชุฌุฏ #3 (ุงูุฃูู)
- ุชุนูุฏ ุงุณุชุฎุฏุงู #3 โ

ุงูุฃุฏูุงุฑ ุงููุดุทุฉ: #1, #2, #3, #4, #6, #8, #9, #10
ุงูุฃุฏูุงุฑ ุงูููุบุงุฉ: #5, #7
```

---

## ๐ ุงููููุฒุงุช

| ุงูููุฒุฉ | ุงููุตู |
|--------|-------|
| โป๏ธ **ุฅุนุงุฏุฉ ุงุณุชุฎุฏุงู ุงูุฃุฑูุงู** | ูุง ุชูุฌุฏ ูุฌูุงุช ูู ุฃุฑูุงู ุงูุฃุฏูุงุฑ |
| ๐ฏ **ุชุฑุชูุจ ููุทูู** | ูุชู ุฅุนุงุฏุฉ ุงุณุชุฎุฏุงู ุงูุฃุฑูุงู ูู ุงูุฃุตุบุฑ ููุฃูุจุฑ |
| ๐ **ูุทุงู ูููู** | ูุจุญุซ ููุท ูู ุงูุฃุฏูุงุฑ ุงูููุบุงุฉ ูููุณ ุงูููู |
| ๐ **ุชููุงุฆู** | ูุนูู ุชููุงุฆูุงู ุนูุฏ ุฅุนุงุฏุฉ ุชูุนูู ุฃู ุฏูุฑ |
| ๐พ **ุขูู** | ูุญุชูุธ ุจุฌููุน ุงูุจูุงูุงุช ูุงูุชุงุฑูุฎ |

---

## ๐งช ุงุฎุชุจุงุฑ ุงููุธุงู

### ุงุฎุชุจุงุฑ 1: ุฅุนุงุฏุฉ ุชูุนูู ุฏูุฑ ููุบู

```bash
# 1. ุฅูุดุงุก ุฏูุฑ ุฌุฏูุฏ
POST /api/reception/add
# ุงููุชูุฌุฉ: ุงูุฏูุฑ #1

# 2. ุฅูุบุงุก ุงูุฏูุฑ
PUT /api/queues/1/cancel

# 3. ุฅุนุงุฏุฉ ุชูุนูู ุงูุฏูุฑ
POST /api/queues/cancelled/1/reinstate
# ุงููุชูุฌุฉ ุงููุชููุนุฉ: ุงูุฏูุฑ #1 (ููุณ ุงูุฑูู) โ
```

### ุงุฎุชุจุงุฑ 2: ุฅูุบุงุก ุนุฏุฉ ุฃุฏูุงุฑ

```bash
# 1. ุฅูุดุงุก 5 ุฃุฏูุงุฑ (#1, #2, #3, #4, #5)
# 2. ุฅูุบุงุก ุงูุฃุฏูุงุฑ #2, #4
# 3. ุฅุนุงุฏุฉ ุชูุนูู ุงูุฏูุฑ #2
# ุงููุชูุฌุฉ ุงููุชููุนุฉ: ุงูุฏูุฑ #2 (ุฅุนุงุฏุฉ ุงุณุชุฎุฏุงู) โ
# 4. ุฅุนุงุฏุฉ ุชูุนูู ุงูุฏูุฑ #4
# ุงููุชูุฌุฉ ุงููุชููุนุฉ: ุงูุฏูุฑ #4 (ุฅุนุงุฏุฉ ุงุณุชุฎุฏุงู) โ
```

---

## ๐ ููุงุญุธุงุช ูููุฉ

### โ ูุง ุชู ุญูู

1. **ุงููุฌูุงุช ูู ุฃุฑูุงู ุงูุฃุฏูุงุฑ**: ุชู ุญููุง ุจุฅุนุงุฏุฉ ุงุณุชุฎุฏุงู ุงูุฃุฑูุงู ุงูููุบุงุฉ
2. **ุฅุนุงุฏุฉ ุงูุชูุนูู**: ุงูุขู ูุญุชูุธ ุจููุณ ุฑูู ุงูุฏูุฑ ุงูุฃุตูู
3. **ุงูุชุฑุชูุจ ุงูููุทูู**: ุงูุฃุฑูุงู ุชูุนุงุฏ ุงุณุชุฎุฏุงููุง ูู ุงูุฃุตุบุฑ ููุฃูุจุฑ

### โ๏ธ ููุงุท ูุฌุจ ูุฑุงุนุงุชูุง

1. **ุงููุทุงู ุงููููู**: ุงููุธููุฉ ุชุจุญุซ ููุท ูู ุงูุฃุฏูุงุฑ ุงูููุบุงุฉ ูููุณ ุงูููู
2. **ุงูุฃุฏุงุก**: ุฅุฐุง ูุงู ููุงู ุนุฏุฏ ูุจูุฑ ูู ุงูุฃุฏูุงุฑ ุงูููุบุงุฉุ ูุฏ ูุคุซุฑ ุนูู ุงูุฃุฏุงุก ููููุงู
3. **ุงูุชุฒุงูู**: ูู ุญุงูุฉ ุงูุชุฒุงูู ุงูุนุงููุ ูุฏ ูุญุฏุซ ุชุถุงุฑุจ (ูุญุชุงุฌ transaction)

### ๐ฎ ุชุญุณููุงุช ูุณุชูุจููุฉ ูุญุชููุฉ

1. **ุฅุถุงูุฉ Transaction**: ูุถูุงู ุนุฏู ุญุฏูุซ ุชุถุงุฑุจ ูู ุญุงูุฉ ุงูุชุฒุงูู ุงูุนุงูู
2. **Cache ููุฃุฑูุงู ุงูููุบุงุฉ**: ูุชุญุณูู ุงูุฃุฏุงุก
3. **ุฅุนุงุฏุฉ ุชุฑุชูุจ ุฏูุฑูุฉ**: ุฅุนุงุฏุฉ ุชุฑุชูุจ ุฌููุน ุงูุฃุฏูุงุฑ ูู ููุงูุฉ ุงูููู

---

## ๐ง ุงููููุงุช ุงููุนุฏูุฉ

| ุงูููู | ุงูุชุบููุฑุงุช |
|------|-----------|
| `src/services/queue.service.ts` | ุฅุถุงูุฉ `getNextAvailableQueueNumber()` ูุชุญุฏูุซ `reinstateQueue()` |

---

## ๐ ุงููุธุงุฆู ุงูููุตุฏูุฑุฉ

ุชู ุฅุถุงูุฉ ูุธููุฉ ุฌุฏูุฏุฉ ููุชุตุฏูุฑ:

```typescript
export {
  getLastQueueNumber,
  updateLastQueueNumber,
  resetQueueNumbers,
  getNextAvailableQueueNumber, // โจ ุฌุฏูุฏ
  createNewQueue,
  getCancelledQueuesForToday,
  reinstateQueue, // โจ ูุญุฏูุซ
  getStationWaitingList,
  getCurrentPatientInStation,
  getAllActiveQueues,
  completeQueue,
  cancelQueue,
  skipPatient,
  changeQueuePriority,
};
```

---

## โ ุงูุญุงูุฉ

- [x] ุฅุถุงูุฉ ูุธููุฉ `getNextAvailableQueueNumber()`
- [x] ุชุญุฏูุซ ูุธููุฉ `reinstateQueue()`
- [x] ุชุตุฏูุฑ ุงููุธููุฉ ุงูุฌุฏูุฏุฉ
- [x] ุงูุชุญูู ูู ุนุฏู ูุฌูุฏ ุฃุฎุทุงุก
- [x] ูุชุงุจุฉ ุงูุชูุซูู

**ุงูุญู ุฌุงูุฒ ููุงุณุชุฎุฏุงู! โจ**

---

## ๐ ุงูุฏุนู

ููุฃุณุฆูุฉ ุฃู ุงููุดุงููุ ูุฑุฌู ูุฑุงุฌุนุฉ:
- `src/services/queue.service.ts` - ุงูููุฏ ุงููุตุฏุฑู
- `md/four/CANCELLED_QUEUE_REINSTATEMENT.md` - ุงูุชูุซูู ุงูุณุงุจู
- `md/four/FINAL_CANCELLED_QUEUE_FIX.md` - ุงูุฅุตูุงุญุงุช ุงูุณุงุจูุฉ

---

**ุชุงุฑูุฎ ุงูุชุทุจูู**: 2 ููููุจุฑ 2025
**ุงูุฅุตุฏุงุฑ**: 1.0
**ุงูุญุงูุฉ**: โ ููุชูู

