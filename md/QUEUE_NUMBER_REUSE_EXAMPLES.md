# ๐งช ุฃูุซูุฉ ุนูู ุงุณุชุฎุฏุงู ูุธุงู ุฅุนุงุฏุฉ ุงุณุชุฎุฏุงู ุฃุฑูุงู ุงูุฃุฏูุงุฑ

## ๐ ูุธุฑุฉ ุนุงูุฉ

ูุฐุง ุงูููู ูุญุชูู ุนูู ุฃูุซูุฉ ุนูููุฉ ูููููุฉ ุนูู ูุธุงู ุฅุนุงุฏุฉ ุงุณุชุฎุฏุงู ุฃุฑูุงู ุงูุฃุฏูุงุฑ ุงูููุบุงุฉ.

---

## ๐ฏ ูุซุงู 1: ุงูุณููุงุฑูู ุงูุฃุณุงุณู

### ุงูุฎุทูุงุช

```typescript
// 1. ุฅูุดุงุก 5 ุฃุฏูุงุฑ
await createReceptionData({ ... }); // ุงูุฏูุฑ #1
await createReceptionData({ ... }); // ุงูุฏูุฑ #2
await createReceptionData({ ... }); // ุงูุฏูุฑ #3
await createReceptionData({ ... }); // ุงูุฏูุฑ #4
await createReceptionData({ ... }); // ุงูุฏูุฑ #5

// ุงูุญุงูุฉ: ุงูุฃุฏูุงุฑ ุงููุดุทุฉ [1, 2, 3, 4, 5]

// 2. ุฅูุบุงุก ุงูุฏูุฑ #3
await cancelQueue(3, "ุณุจุจ ุงูุฅูุบุงุก");

// ุงูุญุงูุฉ: ุงูุฃุฏูุงุฑ ุงููุดุทุฉ [1, 2, 4, 5]
// ุงูุญุงูุฉ: ุงูุฃุฏูุงุฑ ุงูููุบุงุฉ [3]

// 3. ุฅุนุงุฏุฉ ุชูุนูู ุงูุฏูุฑ #3
const result = await reinstateQueue(3);
console.log(result.queueNumber); // 3 โ (ููุณ ุงูุฑูู!)

// ุงูุญุงูุฉ: ุงูุฃุฏูุงุฑ ุงููุดุทุฉ [1, 2, 3, 4, 5]
// ุงูุญุงูุฉ: ุงูุฃุฏูุงุฑ ุงูููุบุงุฉ []
```

### ุงููุชูุฌุฉ

โ **ุฑูู ุงูุฏูุฑ ูุจูู #3** - ูุง ุชูุฌุฏ ูุฌูุงุช ูู ุงูุฃุฑูุงู!

---

## ๐ฏ ูุซุงู 2: ุฅูุบุงุก ุนุฏุฉ ุฃุฏูุงุฑ

### ุงูุฎุทูุงุช

```typescript
// 1. ุฅูุดุงุก 10 ุฃุฏูุงุฑ
for (let i = 1; i <= 10; i++) {
  await createReceptionData({ ... });
}

// ุงูุญุงูุฉ: ุงูุฃุฏูุงุฑ ุงููุดุทุฉ [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]

// 2. ุฅูุบุงุก ุงูุฃุฏูุงุฑ #2, #5, #7
await cancelQueue(2);
await cancelQueue(5);
await cancelQueue(7);

// ุงูุญุงูุฉ: ุงูุฃุฏูุงุฑ ุงููุดุทุฉ [1, 3, 4, 6, 8, 9, 10]
// ุงูุญุงูุฉ: ุงูุฃุฏูุงุฑ ุงูููุบุงุฉ [2, 5, 7]

// 3. ุฅุนุงุฏุฉ ุชูุนูู ุงูุฏูุฑ #5
const result1 = await reinstateQueue(5);
console.log(result1.queueNumber); // 5 โ

// ุงูุญุงูุฉ: ุงูุฃุฏูุงุฑ ุงููุดุทุฉ [1, 3, 4, 5, 6, 8, 9, 10]
// ุงูุญุงูุฉ: ุงูุฃุฏูุงุฑ ุงูููุบุงุฉ [2, 7]

// 4. ุฅุนุงุฏุฉ ุชูุนูู ุงูุฏูุฑ #2
const result2 = await reinstateQueue(2);
console.log(result2.queueNumber); // 2 โ

// ุงูุญุงูุฉ: ุงูุฃุฏูุงุฑ ุงููุดุทุฉ [1, 2, 3, 4, 5, 6, 8, 9, 10]
// ุงูุญุงูุฉ: ุงูุฃุฏูุงุฑ ุงูููุบุงุฉ [7]
```

### ุงููุชูุฌุฉ

โ **ุฌููุน ุงูุฃุฑูุงู ุชู ุฅุนุงุฏุฉ ุงุณุชุฎุฏุงููุง ุจูุฌุงุญ!**

---

## ๐ฏ ูุซุงู 3: ุงุณุชุฎุฏุงู `getNextAvailableQueueNumber()`

### ุงูุณููุงุฑูู

ูููุชุฑุถ ุฃูู ุชุฑูุฏ ุฅูุดุงุก ูุธููุฉ ูุฎุตุตุฉ ูุฅูุดุงุก ุฏูุฑ ุฌุฏูุฏ ุชุณุชุฎุฏู ุงูุฃุฑูุงู ุงูููุบุงุฉ:

```typescript
import { getNextAvailableQueueNumber } from './services/queue.service';

async function createSmartQueue(patientData: any) {
  // 1. ุงูุญุตูู ุนูู ุฑูู ุฏูุฑ ุฐูู (ุฅูุง ููุบู ุฃู ุฌุฏูุฏ)
  const queueNumber = await getNextAvailableQueueNumber();
  
  console.log(`๐ ุณูุชู ุงุณุชุฎุฏุงู ุฑูู ุงูุฏูุฑ: ${queueNumber}`);
  
  // 2. ุฅูุดุงุก ุงููุฑูุถ
  const patient = await createPatient(patientData);
  
  // 3. ุฅูุดุงุก ุงูุฏูุฑ ุจุงูุฑูู ุงููุญุฏุฏ
  const queue = await prisma.queue.create({
    data: {
      queueNumber: queueNumber,
      patientId: patient.id,
      // ... ุจููุฉ ุงูุจูุงูุงุช
    },
  });
  
  return queue;
}
```

### ูุซุงู ุนูู ุงูุงุณุชุฎุฏุงู

```typescript
// ุงูุญุงูุฉ ุงูุฃูููุฉ:
// ุงูุฃุฏูุงุฑ ุงููุดุทุฉ: [1, 2, 4, 6, 8, 9, 10]
// ุงูุฃุฏูุงุฑ ุงูููุบุงุฉ: [3, 5, 7]
// ุขุฎุฑ ุฑูู ุฏูุฑ: 10

// ุงุณุชุฏุนุงุก ุงููุธููุฉ
const queue1 = await createSmartQueue({ name: "ุฃุญูุฏ" });
console.log(queue1.queueNumber); // 3 โ (ุฃูู ุฑูู ููุบู)

// ุงูุญุงูุฉ ุจุนุฏ ุงูุฅูุดุงุก:
// ุงูุฃุฏูุงุฑ ุงููุดุทุฉ: [1, 2, 3, 4, 6, 8, 9, 10]
// ุงูุฃุฏูุงุฑ ุงูููุบุงุฉ: [5, 7]

const queue2 = await createSmartQueue({ name: "ูุญูุฏ" });
console.log(queue2.queueNumber); // 5 โ (ุฃูู ุฑูู ููุบู ูุชุจูู)

// ุงูุญุงูุฉ ุจุนุฏ ุงูุฅูุดุงุก:
// ุงูุฃุฏูุงุฑ ุงููุดุทุฉ: [1, 2, 3, 4, 5, 6, 8, 9, 10]
// ุงูุฃุฏูุงุฑ ุงูููุบุงุฉ: [7]

const queue3 = await createSmartQueue({ name: "ุนูู" });
console.log(queue3.queueNumber); // 7 โ (ุขุฎุฑ ุฑูู ููุบู)

// ุงูุญุงูุฉ ุจุนุฏ ุงูุฅูุดุงุก:
// ุงูุฃุฏูุงุฑ ุงููุดุทุฉ: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
// ุงูุฃุฏูุงุฑ ุงูููุบุงุฉ: []

const queue4 = await createSmartQueue({ name: "ุณุงุฑุฉ" });
console.log(queue4.queueNumber); // 11 โ (ูุง ููุฌุฏ ุฃุฑูุงู ููุบุงุฉุ ุฑูู ุฌุฏูุฏ)

// ุงูุญุงูุฉ ุจุนุฏ ุงูุฅูุดุงุก:
// ุงูุฃุฏูุงุฑ ุงููุดุทุฉ: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11]
// ุงูุฃุฏูุงุฑ ุงูููุบุงุฉ: []
```

---

## ๐ฏ ูุซุงู 4: ุงูุณููุงุฑูู ุงููููู ุงููุงูู

### ุงูููู ุงูุฃูู

```typescript
// ุตุจุงุญ ุงูููู ุงูุฃูู
await resetQueueNumbers(); // ุฅุนุงุฏุฉ ุชุนููู ุงูุฃุฑูุงู ุฅูู 0

// ุฅูุดุงุก ุฃุฏูุงุฑ
await createReceptionData({ ... }); // #1
await createReceptionData({ ... }); // #2
await createReceptionData({ ... }); // #3
await createReceptionData({ ... }); // #4
await createReceptionData({ ... }); // #5

// ุฅูุบุงุก ุจุนุถ ุงูุฃุฏูุงุฑ
await cancelQueue(2);
await cancelQueue(4);

// ุงูุญุงูุฉ: [1, 3, 5] ูุดุทุฉุ [2, 4] ููุบุงุฉ

// ุฅุนุงุฏุฉ ุชูุนูู
await reinstateQueue(2); // ูุนูุฏ ุฑูู #2 โ
await reinstateQueue(4); // ูุนูุฏ ุฑูู #4 โ

// ุงูุญุงูุฉ ุงูููุงุฆูุฉ: [1, 2, 3, 4, 5] ูุดุทุฉ
```

### ุงูููู ุงูุซุงูู

```typescript
// ุตุจุงุญ ุงูููู ุงูุซุงูู
await resetQueueNumbers(); // ุฅุนุงุฏุฉ ุชุนููู ุงูุฃุฑูุงู ุฅูู 0

// ุงูุฃุฏูุงุฑ ุงููุฏููุฉ ูู ุงูููู ุงูุฃูู ูุง ุชุฒุงู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
// ููู ุงูุฃุฑูุงู ุชุจุฏุฃ ูู ุฌุฏูุฏ

await createReceptionData({ ... }); // #1 (ุฌุฏูุฏ ููุฐุง ุงูููู)
await createReceptionData({ ... }); // #2 (ุฌุฏูุฏ ููุฐุง ุงูููู)

// ููุงุญุธุฉ: getNextAvailableQueueNumber() ุชุจุญุซ ููุท ูู ุงูุฃุฏูุงุฑ ุงูููุบุงุฉ ูููุณ ุงูููู
// ูุฐูู ูู ุชุชุฏุงุฎู ูุน ุฃุฏูุงุฑ ุงูููู ุงูุฃูู
```

---

## ๐ฏ ูุซุงู 5: ุงุฎุชุจุงุฑ API

### ุงุณุชุฎุฏุงู REST API

```bash
# 1. ุฅูุดุงุก ุฏูุฑ ุฌุฏูุฏ
curl -X POST http://localhost:3000/api/reception/add \
  -H "Content-Type: application/json" \
  -d '{
    "maleStatus": "NORMAL",
    "femaleStatus": "NORMAL",
    "maleName": "ุฃุญูุฏ",
    "maleLastName": "ูุญูุฏ",
    "femaleName": "ูุงุทูุฉ",
    "femaleLastName": "ุนูู"
  }'

# ุงููุชูุฌุฉ: { "queueNumber": 1, ... }

# 2. ุฅูุบุงุก ุงูุฏูุฑ
curl -X PUT http://localhost:3000/api/queues/1/cancel \
  -H "Content-Type: application/json" \
  -d '{ "reason": "ุชู ุงูุฅูุบุงุก ุจูุงุกู ุนูู ุทูุจ ุงููุฑุงุฌุน" }'

# 3. ุนุฑุถ ุงูุฃุฏูุงุฑ ุงูููุบุงุฉ
curl http://localhost:3000/api/queues/cancelled

# ุงููุชูุฌุฉ: [{ "id": 1, "queueNumber": 1, "status": "CANCELLED", ... }]

# 4. ุฅุนุงุฏุฉ ุชูุนูู ุงูุฏูุฑ
curl -X POST http://localhost:3000/api/queues/cancelled/1/reinstate

# ุงููุชูุฌุฉ: { "queueNumber": 1, ... } โ ููุณ ุงูุฑูู!
```

---

## ๐ ุฌุฏูู ุงูููุงุฑูุฉ

| ุงูุณููุงุฑูู | ูุจู ุงูุชุญุฏูุซ | ุจุนุฏ ุงูุชุญุฏูุซ |
|-----------|-------------|-------------|
| ุฅูุบุงุก ุฏูุฑ #3 ุซู ุฅุนุงุฏุฉ ุชูุนููู | ุฑูู ุฌุฏูุฏ (#11) โ | ููุณ ุงูุฑูู (#3) โ |
| ุฅูุบุงุก 3 ุฃุฏูุงุฑ ุซู ุฅุนุงุฏุฉ ุชูุนูููุง | 3 ุฃุฑูุงู ุฌุฏูุฏุฉ โ | ููุณ ุงูุฃุฑูุงู ุงูุซูุงุซุฉ โ |
| ูุฌูุงุช ูู ุงูุฃุฑูุงู | ููุฌูุฏุฉ โ | ุบูุฑ ููุฌูุฏุฉ โ |
| ุชุฑุชูุจ ุงูุฃุฑูุงู | ุบูุฑ ูุชุณูุณู โ | ูุชุณูุณู โ |

---

## ๐ ูุญุต ุงูุญุงูุฉ

### ุงุณุชุนูุงู SQL ูุนุฑุถ ุงูุฃุฏูุงุฑ

```sql
-- ุนุฑุถ ุฌููุน ุงูุฃุฏูุงุฑ ุงููุดุทุฉ ูุน ุฃุฑูุงููุง
SELECT 
  id,
  queueNumber,
  status,
  createdAt
FROM queues
WHERE 
  status = 'ACTIVE'
  AND DATE(createdAt) = CURDATE()
ORDER BY queueNumber ASC;

-- ุนุฑุถ ุงูุฃุฏูุงุฑ ุงูููุบุงุฉ
SELECT 
  id,
  queueNumber,
  status,
  createdAt
FROM queues
WHERE 
  status = 'CANCELLED'
  AND DATE(createdAt) = CURDATE()
ORDER BY queueNumber ASC;

-- ุงูุชุญูู ูู ูุฌูุฏ ูุฌูุงุช ูู ุงูุฃุฑูุงู
SELECT 
  q1.queueNumber AS current_number,
  q1.queueNumber + 1 AS expected_next,
  MIN(q2.queueNumber) AS actual_next,
  CASE 
    WHEN MIN(q2.queueNumber) - q1.queueNumber > 1 THEN 'GAP FOUND โ๏ธ'
    ELSE 'NO GAP โ'
  END AS gap_status
FROM queues q1
LEFT JOIN queues q2 ON q2.queueNumber > q1.queueNumber
  AND q2.status = 'ACTIVE'
  AND DATE(q2.createdAt) = CURDATE()
WHERE 
  q1.status = 'ACTIVE'
  AND DATE(q1.createdAt) = CURDATE()
GROUP BY q1.queueNumber
HAVING actual_next IS NOT NULL
ORDER BY q1.queueNumber;
```

---

## ๐ ุงูุฏุฑูุณ ุงููุณุชูุงุฏุฉ

### โ ุงููููุฒุงุช

1. **ูุง ุชูุฌุฏ ูุฌูุงุช**: ุงูุฃุฑูุงู ูุชุณูุณูุฉ ุฏุงุฆูุงู
2. **ุฅุนุงุฏุฉ ุงุณุชุฎุฏุงู ุฐููุฉ**: ูุชู ุงุณุชุฎุฏุงู ุงูุฃุฑูุงู ูู ุงูุฃุตุบุฑ ููุฃูุจุฑ
3. **ูุทุงู ูููู**: ูุง ุชุชุฏุงุฎู ูุน ุฃุฏูุงุฑ ุงูุฃูุงู ุงูุณุงุจูุฉ
4. **ุณูู ุงูููู**: ุงููุณุชุฎุฏููู ูุฑูู ุฃุฑูุงู ูุชุณูุณูุฉ

### โ๏ธ ููุงุท ุงูุงูุชุจุงู

1. **ุงูุฃุฏุงุก**: ูู ุญุงูุฉ ูุฌูุฏ ุนุฏุฏ ูุจูุฑ ูู ุงูุฃุฏูุงุฑ ุงูููุบุงุฉุ ูุฏ ูููู ููุงู ุชุฃุซูุฑ ุทููู ุนูู ุงูุฃุฏุงุก
2. **ุงูุชุฒุงูู**: ูู ุญุงูุฉ ุงูุชุฒุงูู ุงูุนุงููุ ูุฏ ูุญุชุงุฌ ุฅูู transaction
3. **ุงููุทุงู ุงููููู**: ุชุฃูุฏ ูู ููู ุฃู ุงูุจุญุซ ูุชู ููุท ูู ููุณ ุงูููู

---

## ๐ ุงููุฑุงุฌุน

- [ุงูุชูุซูู ุงููุงูู](./QUEUE_NUMBER_REUSE_IMPLEMENTATION.md)
- [ุงูููุฏ ุงููุตุฏุฑู](../src/services/queue.service.ts)
- [API Documentation](./first/API_DOCUMENTATION.md)

---

**ุชุงุฑูุฎ ุงูุฅูุดุงุก**: 2 ููููุจุฑ 2025
**ุงูุญุงูุฉ**: โ ุฌุงูุฒ ููุงุณุชุฎุฏุงู

