# دليل إصلاح مشكلة الصوت في شاشة العرض

## 🔴 المشكلة

لم يكن الصوت يعمل عند عرض دور جديد على الشاشة.

### السبب:

المتصفحات الحديثة (Chrome, Firefox, Safari, Edge) تمنع **تشغيل الصوت التلقائي** بدون تفاعل من المستخدم أولاً. هذه سياسة أمان لمنع المواقع من تشغيل أصوات مزعجة تلقائياً.

---

## ✅ الحل المطبق

### 1. إضافة نافذة طلب تفعيل الصوت

عند فتح صفحة العرض لأول مرة، تظهر نافذة منبثقة تطلب من المستخدم تفعيل الصوت:

```typescript
const [audioEnabled, setAudioEnabled] = useState(false);
const [showAudioPrompt, setShowAudioPrompt] = useState(true);

const enableAudio = useCallback(async () => {
  try {
    await audioService.loadVoices();
    // تشغيل صوت تجريبي للتأكد من عمل الصوت
    await audioService.playNotification();
    setAudioEnabled(true);
    setShowAudioPrompt(false);
    console.log("✅ تم تفعيل الصوت");
  } catch (error) {
    console.error("❌ خطأ في تفعيل الصوت:", error);
  }
}, []);
```

### 2. إضافة زر تبديل حالة الصوت في الهيدر

تم إضافة زر في أعلى الشاشة يعرض حالة الصوت ويسمح بتفعيله/إيقافه:

```tsx
<button
  onClick={enableAudio}
  className='text-lg px-4 py-2 rounded-lg transition'
  style={{
    backgroundColor: audioEnabled
      ? "rgba(34, 197, 94, 0.2)"
      : "rgba(239, 68, 68, 0.2)",
    color: audioEnabled ? "#22c55e" : "#ef4444",
  }}>
  {audioEnabled ? "🔊 الصوت مفعل" : "🔇 الصوت معطل"}
</button>
```

### 3. تشغيل الصوت فقط عند التفعيل

الآن يتم التحقق من حالة الصوت قبل تشغيله:

```typescript
if (audioEnabled) {
  const stationName = getStationName(data.displayNumber);
  audioService
    .announcePatient(data.queueNumber, stationName)
    .catch((err) => {
      console.error("❌ خطأ في تشغيل الصوت:", err);
    });
}
```

### 4. تحسين سجل الأحداث (Console Logs)

تم إضافة رسائل تفصيلية في الـ console لتسهيل تتبع عمل الصوت:

```typescript
console.log(`🔊 بدء النداء على الدور #${queueNumber} → ${stationName}`);
console.log('✅ تم تشغيل النغمة');
console.log(`🗣️ قراءة: رقم ${numberText}`);
console.log(`🗣️ قراءة: إلى ${stationName}`);
console.log('✅ انتهى النداء بنجاح');
```

---

## 📋 كيفية الاستخدام

### للمستخدم العادي:

1. افتح صفحة العرض (`/display`)
2. ستظهر نافذة منبثقة: **"تفعيل الصوت"**
3. اضغط على زر **"🔊 تفعيل الصوت"**
4. ستسمع نغمة تجريبية للتأكد من عمل الصوت
5. الآن عند استدعاء أي دور، سيتم تشغيل:
   - نغمة تنبيهية (beep beep)
   - قراءة رقم الدور بالعربية
   - قراءة اسم المحطة

### إذا لم تظهر النافذة:

- اضغط على زر **"🔇 الصوت معطل"** في أعلى اليسار
- سيتم تفعيل الصوت تلقائياً

---

## 🧪 للاختبار

1. افتح صفحة العرض
2. افتح Console في المتصفح (F12)
3. فعّل الصوت من النافذة المنبثقة
4. من صفحة المحاسبة/المختبر/الطبيبة، استدعي مريضاً
5. يجب أن تسمع:
   - ✅ نغمتين تنبيهيتين
   - ✅ "رقم [X]"
   - ✅ "إلى [اسم المحطة]"
6. تحقق من رسائل Console:
   ```
   🔊 بدء النداء على الدور #1 → غرفة المحاسبة
   ✅ تم تشغيل النغمة
   🗣️ قراءة: رقم واحد
   🗣️ قراءة: إلى غرفة المحاسبة
   ✅ انتهى النداء بنجاح
   ```

---

## 🔧 التعديلات التقنية

### الملفات المُعدلة:

1. ✅ `web/src/pages/DisplayScreen.tsx`
   - إضافة state للصوت (`audioEnabled`, `showAudioPrompt`)
   - إضافة دالة `enableAudio`
   - إضافة نافذة منبثقة لتفعيل الصوت
   - إضافة زر حالة الصوت في الهيدر
   - تحديث منطق تشغيل الصوت

2. ✅ `web/src/utils/audioService.ts`
   - إضافة console logs تفصيلية
   - تحسين دالة `loadVoices` لعرض الأصوات المتاحة
   - تحسين معالجة الأخطاء

---

## ⚠️ ملاحظات مهمة

### 1. سياسة Autoplay في المتصفحات:

- **Chrome/Edge:** يمنع الصوت التلقائي تماماً
- **Firefox:** يمنع الصوت التلقائي في معظم الحالات
- **Safari:** صارم جداً في منع الصوت التلقائي

### 2. متطلبات تشغيل الصوت:

- ✅ يجب أن يكون هناك **تفاعل من المستخدم** (نقرة، لمس، إلخ)
- ✅ بعد التفاعل الأول، يمكن تشغيل الأصوات تلقائياً

### 3. الأصوات العربية:

- Windows: يحتوي على أصوات عربية مدمجة
- macOS: يحتوي على صوت عربي (Maged)
- Linux: قد يحتاج تثبيت حزم إضافية
- إذا لم يتوفر صوت عربي، سيستخدم النظام الصوت الافتراضي

---

## 🎯 المميزات الجديدة

1. ✅ نافذة منبثقة جميلة لتفعيل الصوت
2. ✅ زر في الهيدر يعرض حالة الصوت
3. ✅ إمكانية تفعيل/إيقاف الصوت في أي وقت
4. ✅ رسائل console مفصلة لتتبع الأحداث
5. ✅ معالجة أخطاء محسنة
6. ✅ تجربة مستخدم سلسة

---

## 🚀 للمستقبل (اختياري)

يمكن تحسين النظام أكثر بـ:

1. **حفظ تفضيلات الصوت** في localStorage
2. **إضافة شريط تحكم بمستوى الصوت**
3. **اختيار نوع الصوت** (ذكر/أنثى)
4. **تسجيلات صوتية مخصصة** بدلاً من TTS
5. **دعم لغات متعددة**

---

تاريخ الإصلاح: 12 أكتوبر 2025  
الحالة: ✅ جاهز للاستخدام

