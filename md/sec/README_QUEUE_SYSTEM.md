# 🏥 نظام إدارة الأدوار - دليل شامل

## 📖 نظرة عامة

نظام متكامل لإدارة أدوار المرضى في العيادات والمستشفيات، يتتبع حركة المريض عبر محطات متعددة ويعرض الاستدعاءات على شاشات عامة.

---

## ✨ المميزات الرئيسية

### 🔄 **تتبع شامل للمريض**
- تتبع دقيق لحركة كل مريض عبر جميع المحطات
- حفظ تاريخ كامل لكل خطوة (الاستدعاء، البدء، الانتهاء)
- أرشفة تلقائية عند إكمال الرحلة

### 📊 **فصل واضح للمحطات**
- كل محطة لها قائمة مستقلة
- عرض المريض الحالي والمرضى المنتظرين
- انتقال تلقائي بين المحطات

### 📺 **شاشة عرض عامة**
- عرض آخر الاستدعاءات للمرضى
- يظهر رقم الدور ورقم الشاشة المطلوبة
- تحديثات لحظية عبر WebSocket

### 📈 **إحصائيات وتقارير**
- متوسط أوقات الانتظار والخدمة
- عدد المرضى اليومي لكل محطة
- تقارير تفصيلية لكل مريض

### 🎯 **نظام أولويات**
- إمكانية تعيين أولوية عالية لحالات طارئة
- ترتيب تلقائي حسب الأولوية ثم رقم الدور

---

## 🗂️ بنية النظام

### **الملفات المرجعية:**

```
📁 المشروع/
│
├── 📄 prisma/schema.prisma
│   └── تعريف قاعدة البيانات الكاملة (6 جداول + 2 Enums)
│
├── 📄 QUEUE_SYSTEM_LOGIC.md
│   └── شرح تفصيلي لمنطق العمل مع أمثلة كود
│
├── 📄 DATABASE_SCHEMA_DIAGRAM.md
│   └── مخططات بصرية للعلاقات والاستعلامات
│
├── 📄 QUEUE_SERVICE_EXAMPLES.ts
│   └── دوال TypeScript جاهزة للاستخدام (40+ دالة)
│
├── 📄 API_ENDPOINTS_GUIDE.md
│   └── دليل كامل لجميع الـ API endpoints
│
├── 📄 IMPLEMENTATION_PLAN.md
│   └── خطة تنفيذ خطوة بخطوة
│
└── 📄 README_QUEUE_SYSTEM.md (هذا الملف)
    └── الملخص الشامل والبداية السريعة
```

---

## 🏗️ قاعدة البيانات

### **الجداول الرئيسية:**

| الجدول | الوصف | العلاقات |
|--------|-------|----------|
| **Patient** | بيانات المريض الأساسية | 1:N مع Queue و CompletedVisit |
| **Station** | المحطات/الأجهزة | 1:N مع Queue و QueueHistory |
| **Queue** | الدور النشط الحالي | N:1 مع Patient و Station، 1:N مع QueueHistory |
| **QueueHistory** | سجل تحركات المريض | N:1 مع Queue و Station |
| **CompletedVisit** | أرشيف الزيارات المكتملة | N:1 مع Patient |
| **SystemSettings** | إعدادات النظام | مستقل |

### **الحالات (Enums):**

```typescript
// حالة الدور في المحطة
enum QueueStatus {
  WAITING       // في الانتظار
  CALLED        // تم الاستدعاء
  IN_PROGRESS   // قيد الخدمة
  COMPLETED     // مكتمل
  CANCELLED     // ملغي
  SKIPPED       // تم التخطي
}

// حالة الدور الكلية
enum OverallQueueStatus {
  ACTIVE        // نشط (يتنقل بين المحطات)
  COMPLETED     // أنهى جميع المحطات
  CANCELLED     // ملغي
}
```

---

## 🔄 سير العمل

### **رحلة المريض الكاملة:**

```
1️⃣ الاستقبال
   ↓
   • إنشاء سجل المريض (Patient)
   • إنشاء دور جديد (Queue)
   • إضافة لقائمة المحطة 1
   ↓
2️⃣ المحطة 1
   ↓
   • استدعاء → يظهر على الشاشة
   • بدء الخدمة
   • إنهاء الخدمة
   • انتقال تلقائي للمحطة 2
   ↓
3️⃣ المحطة 2
   ↓
   • نفس العملية...
   • انتقال للمحطة 3
   ↓
4️⃣ المحطة 3
   ↓
   • نفس العملية...
   • عند الانتهاء → أرشفة تلقائية
   ↓
5️⃣ الأرشيف (CompletedVisit)
   ↓
   • حفظ جميع البيانات والإحصائيات
   • المريض انتهى من رحلته
```

---

## 🚀 البداية السريعة

### **الخطوة 1: إعداد قاعدة البيانات**

```bash
# 1. تعديل ملف .env
DATABASE_URL="mysql://user:password@localhost:3306/queue_system"

# 2. تشغيل Migration
npx prisma migrate dev --name init_queue_system

# 3. توليد Prisma Client
npx prisma generate

# 4. إضافة البيانات الأولية
npx prisma db seed
```

### **الخطوة 2: تشغيل Backend**

```bash
# تثبيت المكتبات
npm install

# تشغيل في وضع التطوير
npm run dev

# Server سيعمل على http://localhost:3000
```

### **الخطوة 3: تشغيل Frontend**

```bash
cd web

# تثبيت المكتبات
npm install

# تشغيل
npm run dev

# Frontend سيعمل على http://localhost:5173
```

---

## 📡 API الرئيسية

### **إنشاء دور جديد:**
```bash
POST /api/queue/create
{
  "name": "أحمد محمد",
  "phoneNumber": "0501234567",
  "priority": 0
}
```

### **استدعاء المريض التالي:**
```bash
POST /api/stations/1/call-next
{
  "calledBy": "موظف الاستقبال"
}
```

### **إنهاء الخدمة:**
```bash
POST /api/stations/1/complete-service
{
  "queueId": 5,
  "notes": "تم بنجاح"
}
```

### **الشاشة العامة:**
```bash
GET /api/display/recent-calls
```

### **الإحصائيات:**
```bash
GET /api/stats/today
```

---

## 💡 أمثلة عملية

### **مثال 1: سيناريو يوم كامل**

```
⏰ 9:00 صباحاً - الاستقبال
├─ المريض "أحمد" يصل → دور #1
├─ المريض "فاطمة" تصل → دور #2
└─ المريض "خالد" يصل → دور #3

⏰ 9:05 - المحطة 1 (الفحص الأولي)
├─ استدعاء الدور #1 (أحمد)
├─ الشاشة تعرض: "الدور 1 → الشاشة 1"
└─ بدء الخدمة

⏰ 9:15 - المحطة 1
├─ انتهى أحمد من المحطة 1
└─ انتقل تلقائياً للمحطة 2

⏰ 9:15 - المحطة 1
├─ استدعاء الدور #2 (فاطمة)
└─ الشاشة تعرض: "الدور 2 → الشاشة 1"

⏰ 9:20 - المحطة 2 (الطبيب)
├─ استدعاء الدور #1 (أحمد)
└─ الشاشة تعرض: "الدور 1 → الشاشة 2"

... وهكذا
```

### **مثال 2: نظرة على لوحة التحكم**

```
╔════════════════════════════════════════╗
║         إحصائيات اليوم                 ║
╠════════════════════════════════════════╣
║ المرضى المكتملون:    45               ║
║ المرضى النشطون:       8               ║
║ متوسط الانتظار:       15 دقيقة        ║
║ متوسط الخدمة:         10 دقائق        ║
╚════════════════════════════════════════╝

╔════════════════════════════════════════╗
║         حالة المحطات                   ║
╠════════════════════════════════════════╣
║ المحطة 1: 5 منتظرين | مشغول          ║
║ المحطة 2: 3 منتظرين | متاح           ║
║ المحطة 3: 1 منتظر    | مشغول          ║
╚════════════════════════════════════════╝
```

---

## 🎨 واجهات المستخدم

### **1. واجهة الاستقبال**
- نموذج إدخال بيانات المريض
- إنشاء دور جديد
- البحث عن مريض سابق

### **2. واجهة المحطة**
- قائمة المرضى المنتظرين
- المريض الحالي (قيد الخدمة)
- أزرار: استدعاء التالي، بدء الخدمة، إنهاء
- عرض لحظي للتحديثات

### **3. الشاشة العامة**
- عرض بالشاشة الكاملة
- آخر 10 استدعاءات
- تنسيق واضح: "الدور X → الشاشة Y"
- تحديث تلقائي لحظي

### **4. لوحة الإحصائيات**
- مخططات بيانية
- تقارير يومية/أسبوعية/شهرية
- تحليل أداء كل محطة
- تاريخ المرضى

---

## 🔧 التخصيص والتوسع

### **إضافة محطة جديدة:**
```typescript
await prisma.station.create({
  data: {
    name: 'الصيدلية',
    displayNumber: 4,
    order: 4,
    description: 'صرف الأدوية',
  }
});
```

### **تعديل أوقات الانتظار:**
```typescript
// في QueueHistory
const waitingTime = Math.floor(
  (startedAt.getTime() - createdAt.getTime()) / 60000
);
```

### **إضافة مستويات أولوية:**
```typescript
enum Priority {
  NORMAL = 0,
  HIGH = 1,
  URGENT = 2,
  EMERGENCY = 3
}
```

---

## 📊 إحصائيات وتحليلات

### **يمكن حساب:**
- ✅ متوسط وقت الانتظار لكل محطة
- ✅ متوسط وقت الخدمة لكل محطة
- ✅ عدد المرضى في كل ساعة/يوم/أسبوع
- ✅ أوقات الذروة
- ✅ كفاءة كل محطة
- ✅ نسب الإلغاءات
- ✅ أطول/أقصر زيارة

---

## 🔐 الأمان والصلاحيات

### **للإصدارات المستقبلية:**
- مصادقة المستخدمين (JWT)
- صلاحيات مختلفة لكل دور (استقبال، طبيب، إداري)
- تشفير البيانات الحساسة
- سجل تدقيق للعمليات (Audit Log)

---

## 🧪 الاختبار

### **اختبار سريع:**
```bash
# 1. إنشاء دور جديد
curl -X POST http://localhost:3000/api/queue/create \
  -H "Content-Type: application/json" \
  -d '{"name":"Test Patient","phoneNumber":"0500000000"}'

# 2. استدعاء المريض
curl -X POST http://localhost:3000/api/stations/1/call-next \
  -H "Content-Type: application/json" \
  -d '{"calledBy":"Test User"}'

# 3. الحصول على الإحصائيات
curl http://localhost:3000/api/stats/today
```

---

## 📝 التوثيق الكامل

### **للمزيد من التفاصيل، راجع:**

1. **[QUEUE_SYSTEM_LOGIC.md](./QUEUE_SYSTEM_LOGIC.md)**  
   شرح مفصل للمنطق مع أمثلة كود TypeScript

2. **[DATABASE_SCHEMA_DIAGRAM.md](./DATABASE_SCHEMA_DIAGRAM.md)**  
   مخططات بصرية للعلاقات واستعلامات SQL

3. **[QUEUE_SERVICE_EXAMPLES.ts](./QUEUE_SERVICE_EXAMPLES.ts)**  
   40+ دالة جاهزة للاستخدام

4. **[API_ENDPOINTS_GUIDE.md](./API_ENDPOINTS_GUIDE.md)**  
   دليل كامل لجميع الـ endpoints

5. **[IMPLEMENTATION_PLAN.md](./IMPLEMENTATION_PLAN.md)**  
   خطة تنفيذ مفصلة خطوة بخطوة

---

## 🐛 المشاكل الشائعة وحلولها

### **1. "لا يوجد مرضى في قائمة الانتظار"**
```typescript
// تأكد من أن:
// 1. الدور تم إنشاؤه بنجاح
// 2. currentStationId يطابق stationId
// 3. حالة QueueHistory هي WAITING
```

### **2. "لا يتم تحديث القوائم تلقائياً"**
```typescript
// تأكد من:
// 1. WebSocket متصل
// 2. Client مشترك في القناة الصحيحة
// 3. Server يرسل الأحداث
```

### **3. "أرقام الأدوار لا تُعاد يومياً"**
```typescript
// إضافة Cron Job:
import cron from 'node-cron';

cron.schedule('0 0 * * *', async () => {
  await resetQueueNumbers();
});
```

---

## 🎯 الأهداف المستقبلية

- [ ] تطبيق موبايل للمرضى (تتبع الدور)
- [ ] إشعارات SMS عند الاستدعاء
- [ ] حجز مواعيد مسبقة
- [ ] تكامل مع أنظمة السجلات الطبية
- [ ] تقارير متقدمة وتحليلات AI
- [ ] دعم عيادات متعددة

---

## 🤝 المساهمة

نرحب بمساهماتكم! يمكنكم:
- الإبلاغ عن مشاكل
- اقتراح ميزات جديدة
- تحسين التوثيق
- إرسال Pull Requests

---

## 📄 الترخيص

هذا المشروع مفتوح المصدر ومتاح للاستخدام الحر.

---

## 📞 الدعم

للأسئلة أو المساعدة:
- راجع الملفات التوثيقية أعلاه
- افتح Issue في GitHub
- راسلنا عبر البريد الإلكتروني

---

## 🎉 شكر خاص

تم تصميم هذا النظام لتحسين تجربة المرضى وكفاءة العمل في العيادات والمستشفيات.

**بالتوفيق في تطبيق النظام! 🚀**

---

<div dir="rtl" align="center">

**صُنع بـ ❤️ لخدمة القطاع الصحي**

</div>

