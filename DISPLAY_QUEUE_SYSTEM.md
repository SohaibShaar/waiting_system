# ูุธุงู ุทุงุจูุฑ ุงูุนุฑุถ - Display Queue System

## ๐ฏ ุงููุฏู

ุชุญุณูู ุนุฑุถ ุงูุฃุฏูุงุฑ ุนูู ุงูุดุงุดุฉ ุจุญูุซ:
1. **ูุจูู ูู ุฏูุฑ ููุฏุฉ 5 ุซูุงูู ุนูู ุงูุฃูู** ุนูู ุงูุดุงุดุฉ
2. **ุนุฏู ููุงุทุนุฉ ุงูุตูุช**: ุฅุฐุง ุชู ุงุณุชุฏุนุงุก ุฏูุฑ ุฌุฏูุฏุ ููุชุธุฑ ุญุชู ููุชูู ุงูุตูุช ุงูุญุงูู
3. **ูุนุงูุฌุฉ ุชุณูุณููุฉ**: ุงูุฃุฏูุงุฑ ุชูุนุงูุฌ ูุงุญุฏุงู ุชูู ุงูุขุฎุฑ ุจุฏูู ุชุฏุงุฎู

---

## ๐ง ููู ูุนูู ุงููุธุงู

### 1. ุทุงุจูุฑ ุงูุงูุชุธุงุฑ (Queue)

```typescript
const pendingCallsRef = useRef<CalledPatient[]>([]);
```

- ูุชู ุชุฎุฒูู ุฌููุน ุงูุฃุฏูุงุฑ ุงููุงุฑุฏุฉ ูู ุทุงุจูุฑ ุงูุชุธุงุฑ
- ุงุณุชุฎุฏุงู `useRef` ูุชุฌูุจ ุฅุนุงุฏุฉ render ุบูุฑ ุถุฑูุฑูุฉ
- ุงูุฃุฏูุงุฑ ุชูุถุงู ุฅูู ููุงูุฉ ุงูุทุงุจูุฑ

### 2. ุญุงูุฉ ุงููุนุงูุฌุฉ

```typescript
const [isProcessingAnnouncement, setIsProcessingAnnouncement] = useState(false);
```

- `true`: ูุชู ูุนุงูุฌุฉ ุฏูุฑ ุญุงููุงู (ุตูุช + ุนุฑุถ + ุงูุชุธุงุฑ)
- `false`: ุงููุธุงู ุฌุงูุฒ ููุนุงูุฌุฉ ุงูุฏูุฑ ุงูุชุงูู

### 3. ุฏูุฑุฉ ุญูุงุฉ ุงูุฏูุฑ (Lifecycle)

```
ุงุณุชุฏุนุงุก ุฌุฏูุฏ
    โ
ุฅุถุงูุฉ ููุทุงุจูุฑ
    โ
ุงูุชุธุงุฑ ุงูุฏูุฑ ุงูุณุงุจู
    โ
ุจุฏุก ุงููุนุงูุฌุฉ (isProcessing = true)
    โ
ุนุฑุถ ุนูู ุงูุดุงุดุฉ
    โ
ุชุดุบูู ุงูุตูุช (3-5 ุซูุงูู)
    โ
ุงูุชุธุงุฑ 5 ุซูุงูู ุฅุถุงููุฉ
    โ
ุฅุฒุงูุฉ ูู ุงูุทุงุจูุฑ
    โ
ููุงูุฉ ุงููุนุงูุฌุฉ (isProcessing = false)
    โ
ูุนุงูุฌุฉ ุงูุฏูุฑ ุงูุชุงูู (ุฅู ูุฌุฏ)
```

---

## ๐ ุงูููุฏ ุงูุฃุณุงุณู

### ุงุณุชูุจุงู ุฏูุฑ ุฌุฏูุฏ

```typescript
newSocket.on("patient-called", (data: CalledPatient) => {
  console.log("๐ข ูุฑูุถ ุฌุฏูุฏ:", data);

  // ุชุฌูุจ ุงูุชูุฑุงุฑ
  setRecentCalls((prev) => {
    const isDuplicate = prev.some(
      (call) =>
        call.queueNumber === data.queueNumber &&
        call.displayNumber === data.displayNumber &&
        Math.abs(
          new Date(call.calledAt).getTime() -
            new Date(data.calledAt).getTime()
        ) < 2000
    );

    if (isDuplicate) {
      console.log("โ๏ธ ุชุฌุงูู ุงุณุชุฏุนุงุก ููุฑุฑ");
      return prev;
    }

    return prev;
  });

  // ุฅุถุงูุฉ ุฅูู ุทุงุจูุฑ ุงูุงูุชุธุงุฑ
  pendingCallsRef.current.push(data);
  console.log(`โ ุชูุช ุฅุถุงูุฉ ุงูุฏูุฑ #${data.queueNumber} ุฅูู ุงูุทุงุจูุฑ`);
  console.log(`๐ ุนุฏุฏ ุงูุฃุฏูุงุฑ ูู ุงูุทุงุจูุฑ: ${pendingCallsRef.current.length}`);
  forceUpdate({}); // ุฅุนุงุฏุฉ ุชุดุบูู effect
});
```

### ูุนุงูุฌุฉ ุงูุทุงุจูุฑ

```typescript
useEffect(() => {
  if (isProcessingAnnouncement || pendingCallsRef.current.length === 0) {
    return; // ูุง ููุฌุฏ ุดูุก ูููุนุงูุฌุฉ
  }

  const processNextCall = async () => {
    setIsProcessingAnnouncement(true);
    const nextCall = pendingCallsRef.current[0];
    
    console.log(`๐ ูุนุงูุฌุฉ ุงูุฏูุฑ #${nextCall.queueNumber}`);
    console.log(`๐ ุนุฏุฏ ุงูุฃุฏูุงุฑ ุงูููุชุธุฑุฉ: ${pendingCallsRef.current.length}`);

    try {
      // 1. ุนุฑุถ ุนูู ุงูุดุงุดุฉ
      setRecentCalls((prev) => [nextCall, ...prev].slice(0, 10));

      // 2. ุชุดุบูู ุงูุตูุช
      if (audioEnabled) {
        const stationName = getStationName(nextCall.displayNumber);
        console.log(`๐ ุชุดุบูู ุงูุตูุช ููุฏูุฑ #${nextCall.queueNumber}`);
        await audioService.announcePatient(nextCall.queueNumber, stationName);
        console.log(`โ ุงูุชูู ุงูุตูุช ููุฏูุฑ #${nextCall.queueNumber}`);
      }

      // 3. ุงูุงูุชุธุงุฑ 5 ุซูุงูู
      console.log(`โณ ุงูุชุธุงุฑ 5 ุซูุงูู ููุฏูุฑ #${nextCall.queueNumber}`);
      await new Promise((resolve) => setTimeout(resolve, 5000));

      // 4. ุฅุฒุงูุฉ ูู ุงูุทุงุจูุฑ
      pendingCallsRef.current = pendingCallsRef.current.slice(1);
      console.log(`โ ุชู ุงูุงูุชูุงุก ูู ูุนุงูุฌุฉ ุงูุฏูุฑ #${nextCall.queueNumber}`);
      
      // 5. ูุนุงูุฌุฉ ุงูุชุงูู
      forceUpdate({});
    } catch (error) {
      console.error("โ ุฎุทุฃ ูู ูุนุงูุฌุฉ ุงูุฏูุฑ:", error);
      pendingCallsRef.current = pendingCallsRef.current.slice(1);
      forceUpdate({});
    } finally {
      setIsProcessingAnnouncement(false);
    }
  };

  processNextCall();
}, [isProcessingAnnouncement, audioEnabled, getStationName]);
```

---

## โฑ๏ธ ุงูุชูููุชุงุช

### ูุน ุชูุนูู ุงูุตูุช:
- **ุงููุบูุฉ ุงูุชูุจูููุฉ**: ~0.5 ุซุงููุฉ
- **ูุฑุงุกุฉ ุฑูู ุงูุฏูุฑ**: ~2-3 ุซูุงูู
- **ูุฑุงุกุฉ ุงุณู ุงููุญุทุฉ**: ~1-2 ุซุงููุฉ
- **ุงูุชุธุงุฑ ุฅุถุงูู**: 5 ุซูุงูู
- **ุงููุฌููุน**: ~8-11 ุซุงููุฉ ููู ุฏูุฑ

### ุจุฏูู ุตูุช:
- **ุงูุชุธุงุฑ ููุท**: 5 ุซูุงูู ููู ุฏูุฑ

---

## ๐ ุฃูุซูุฉ ุนูู ุงูุณููุงุฑูููุงุช

### ุงูุณููุงุฑูู 1: ุฏูุฑ ูุงุญุฏ
```
ุงูููุช 0s: ุงุณุชุฏุนุงุก ุฏูุฑ #1
ุงูููุช 0s: ุนุฑุถ ุฏูุฑ #1
ุงูููุช 0-4s: ุชุดุบูู ุงูุตูุช
ุงูููุช 4-9s: ุงูุชุธุงุฑ 5 ุซูุงูู
ุงูููุช 9s: ุฌุงูุฒ ููุฏูุฑ ุงูุชุงูู
```

### ุงูุณููุงุฑูู 2: ุฏูุฑูู ูุชุชุงูููู
```
ุงูููุช 0s: ุงุณุชุฏุนุงุก ุฏูุฑ #1
ุงูููุช 0s: ุจุฏุก ูุนุงูุฌุฉ ุฏูุฑ #1
ุงูููุช 2s: ุงุณุชุฏุนุงุก ุฏูุฑ #2 (ููุถุงู ููุทุงุจูุฑ)
ุงูููุช 9s: ุงูุชูู ุฏูุฑ #1
ุงูููุช 9s: ุจุฏุก ูุนุงูุฌุฉ ุฏูุฑ #2
ุงูููุช 18s: ุงูุชูู ุฏูุฑ #2
```

### ุงูุณููุงุฑูู 3: ุซูุงุซุฉ ุฃุฏูุงุฑ ูุชูุงุฑุจุฉ
```
ุงูููุช 0s: ุงุณุชุฏุนุงุก ุฏูุฑ #1 โ ูุนุงูุฌุฉ
ุงูููุช 1s: ุงุณุชุฏุนุงุก ุฏูุฑ #2 โ ุทุงุจูุฑ
ุงูููุช 2s: ุงุณุชุฏุนุงุก ุฏูุฑ #3 โ ุทุงุจูุฑ
ุงูููุช 9s: ุงูุชูู ุฏูุฑ #1ุ ุจุฏุก ุฏูุฑ #2
ุงูููุช 18s: ุงูุชูู ุฏูุฑ #2ุ ุจุฏุก ุฏูุฑ #3
ุงูููุช 27s: ุงูุชูู ุฏูุฑ #3
```

---

## ๐จ ุฑุณุงุฆู Console ููุชุชุจุน

### ุนูุฏ ุฅุถุงูุฉ ุฏูุฑ ุฌุฏูุฏ:
```
๐ข ูุฑูุถ ุฌุฏูุฏ: {queueNumber: 1, displayNumber: 2, ...}
โ ุชูุช ุฅุถุงูุฉ ุงูุฏูุฑ #1 ุฅูู ุงูุทุงุจูุฑ
๐ ุนุฏุฏ ุงูุฃุฏูุงุฑ ูู ุงูุทุงุจูุฑ: 1
```

### ุฃุซูุงุก ุงููุนุงูุฌุฉ:
```
๐ ูุนุงูุฌุฉ ุงูุฏูุฑ #1
๐ ุนุฏุฏ ุงูุฃุฏูุงุฑ ุงูููุชุธุฑุฉ: 1
๐ ุชุดุบูู ุงูุตูุช ููุฏูุฑ #1
โ ุงูุชูู ุงูุตูุช ููุฏูุฑ #1
โณ ุงูุชุธุงุฑ 5 ุซูุงูู ููุฏูุฑ #1
โ ุชู ุงูุงูุชูุงุก ูู ูุนุงูุฌุฉ ุงูุฏูุฑ #1
๐ ุงูุฃุฏูุงุฑ ุงููุชุจููุฉ: 0
```

### ุนูุฏ ุชุนุทูู ุงูุตูุช:
```
๐ ุงูุตูุช ูุนุทู - ูู ูุชู ุชุดุบูู ุงููุฏุงุก
```

---

## โ ุงููููุฒุงุช

1. โ **ุนุฏู ุงูุชุฏุงุฎู**: ุฏูุฑ ูุงุญุฏ ููุท ููุนุงูุฌ ูู ูู ูุฑุฉ
2. โ **ุงูุชุฑุชูุจ ูุญููุธ**: FIFO (First In First Out)
3. โ **ุงูุตูุช ูุง ูููุงุทุน**: ููุชูู ุงูุตูุช ูุงููุงู ูุจู ุงูุงูุชูุงู
4. โ **ูุฏุฉ ุนุฑุถ ูุถูููุฉ**: 5 ุซูุงูู ุนูู ุงูุฃูู ููู ุฏูุฑ
5. โ **ูุนุงูุฌุฉ ุฃุฎุทุงุก ูููุฉ**: ุญุชู ูุน ุงูุฃุฎุทุงุกุ ุงููุธุงู ูุณุชูุฑ
6. โ **ุณุฌู ุชูุตููู**: ุฑุณุงุฆู console ูุงุถุญุฉ ููุชุชุจุน

---

## ๐งช ููุงุฎุชุจุงุฑ

### ุงุฎุชุจุงุฑ 1: ุฏูุฑ ูุงุญุฏ
1. ูุนูู ุงูุตูุช
2. ุงุณุชุฏุนู ุฏูุฑ ูู ุฃู ูุญุทุฉ
3. **ุงููุชููุน**: ุตูุช + 5 ุซูุงูู ุนุฑุถ

### ุงุฎุชุจุงุฑ 2: ุฃุฏูุงุฑ ูุชุชุงููุฉ ุณุฑูุนุฉ
1. ูุนูู ุงูุตูุช
2. ุงุณุชุฏุนู 3 ุฃุฏูุงุฑ ุจุณุฑุนุฉ (ุฎูุงู ุซุงููุฉ ูุงุญุฏุฉ)
3. **ุงููุชููุน**: 
   - ุงูุฏูุฑ 1 ูุธูุฑ ูููุณูุน ุตูุชู
   - ุงูุฏูุฑ 2 ููุชุธุฑ ุญุชู ููุชูู ุงูุฏูุฑ 1
   - ุงูุฏูุฑ 3 ููุชุธุฑ ุญุชู ููุชูู ุงูุฏูุฑ 2
   - ูุง ุชุฏุงุฎู ูู ุงูุฃุตูุงุช

### ุงุฎุชุจุงุฑ 3: ุจุฏูู ุตูุช
1. ุนุทูู ุงูุตูุช
2. ุงุณุชุฏุนู ุฏูุฑ
3. **ุงููุชููุน**: ุนุฑุถ 5 ุซูุงูู ููุท ุจุฏูู ุตูุช

---

## ๐ง ุชุฎุตูุต ุงููุฏุฉ

ูุชุบููุฑ ูุฏุฉ ุงูุนุฑุถ ูู 5 ุซูุงูู:

```typescript
// ุงูุณุทุฑ 80
await new Promise((resolve) => setTimeout(resolve, 5000));
//                                                   ^^^^
//                                                   ุงููุฏุฉ ุจุงููููู ุซุงููุฉ
```

ูุซุงู: 10 ุซูุงูู โ `10000`

---

## ๐ ููุงุญุธุงุช ุชูููุฉ

### ุงุณุชุฎุฏุงู useRef ุจุฏูุงู ูู useState:
- `useRef` ูุง ูุณุจุจ re-render ุนูุฏ ุงูุชุญุฏูุซ
- ูุซุงูู ููุทูุงุจูุฑ ูุงูุจูุงูุงุช ุงููุคูุชุฉ
- ุฃุณุฑุน ูุฃูุซุฑ ููุงุกุฉ

### forceUpdate:
```typescript
const [, forceUpdate] = useState({});
// ...
forceUpdate({}); // ููุฌุจุฑ React ุนูู ุฅุนุงุฏุฉ ุชุดุบูู useEffect
```

### async/await ูู useEffect:
- ูุง ูููู ุฌุนู useEffect ููุณู async
- ูุฐูู ูุณุชุฎุฏู ุฏุงูุฉ async ุฏุงุฎููุฉ

---

ุชุงุฑูุฎ ุงูุชุญุฏูุซ: 12 ุฃูุชูุจุฑ 2025  
ุงูุญุงูุฉ: โ ุฌุงูุฒ ููุงุณุชุฎุฏุงู

